<!-- Live2D ä¸‰ä½ç½®æ¿å¨˜ -->
<link rel="stylesheet" type="text/css" href="https://blog-static.cnblogs.com/files/zhangshuhao1116/waifu1.css"/>
<link rel="stylesheet" type="text/css" href="https://blog-static.cnblogs.com/files/zhangshuhao1116/flat-ui.min.css"/>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

<!-- æ¿å¨˜1 - MIHARI (å·¦ä¾§) -->
<div class="waifu" id="waifu1" style="left: 20px; bottom: 0; z-index: 9999;">
  <div class="waifu-tips" style="opacity: 1;"></div>
  <canvas id="live2d1" width="280" height="250" class="live2d"></canvas>
  <div class="waifu-tool">
    <span class="fui-home"></span>
    <span class="fui-chat"></span>
    <span class="fui-eye"></span>
    <span class="fui-user"></span>
    <span class="fui-photo"></span>
    <span class="fui-info-circle"></span>
    <span class="fui-cross"></span>
  </div>
</div>

<!-- æ¿å¨˜2 - Rory (ä¸­é—´) -->
<div class="waifu" id="waifu2" style="left: 320px; bottom: 0; z-index: 9999;">
  <div class="waifu-tips" style="opacity: 1;"></div>
  <canvas id="live2d2" width="280" height="250" class="live2d"></canvas>
  <div class="waifu-tool">
    <span class="fui-home"></span>
    <span class="fui-chat"></span>
    <span class="fui-eye"></span>
    <span class="fui-user"></span>
    <span class="fui-photo"></span>
    <span class="fui-info-circle"></span>
    <span class="fui-cross"></span>
  </div>
</div>

<!-- æ¿å¨˜3 - Alya (å³ä¾§) -->
<div class="waifu" id="waifu3" style="left: 620px; bottom: 0; z-index: 9999;">
  <div class="waifu-tips" style="opacity: 1;"></div>
  <canvas id="live2d3" width="280" height="250" class="live2d"></canvas>
  <div class="waifu-tool">
    <span class="fui-home"></span>
    <span class="fui-chat"></span>
    <span class="fui-eye"></span>
    <span class="fui-user"></span>
    <span class="fui-photo"></span>
    <span class="fui-info-circle"></span>
    <span class="fui-cross"></span>
  </div>
</div>

<!-- å¼•å…¥Live2Dè„šæœ¬ -->
<script src="https://blog-static.cnblogs.com/files/zhangshuhao1116/live2d.min.js"></script>
<script src="https://blog-static.cnblogs.com/files/zhangshuhao1116/waifu-tips.js"></script>

<!-- åˆå§‹åŒ–å¤šä¸ªæ¨¡å‹ -->
<script type="text/javascript">
  // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    console.log('å¼€å§‹åˆå§‹åŒ–ä¸‰ä¸ªLive2Dæ¿å¨˜');
    
    // åˆå§‹åŒ–æ¿å¨˜1ï¼ˆMIHARIï¼‰
    try {
      initModel("live2d1", "waifu1");
      console.log('æ¿å¨˜1 (MIHARI) åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      console.error('æ¿å¨˜1åˆå§‹åŒ–å¤±è´¥:', error);
    }
    
    // åˆå§‹åŒ–æ¿å¨˜2ï¼ˆRoryï¼‰
    try {
      initModel("live2d2", "waifu2");
      console.log('æ¿å¨˜2 (Rory) åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      console.error('æ¿å¨˜2åˆå§‹åŒ–å¤±è´¥:', error);
    }
    
    // åˆå§‹åŒ–æ¿å¨˜3ï¼ˆAlyaï¼‰
    try {
      initModel("live2d3", "waifu3");
      console.log('æ¿å¨˜3 (Alya) åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      console.error('æ¿å¨˜3åˆå§‹åŒ–å¤±è´¥:', error);
    }
  });
</script>

<!-- ç½‘æ˜“äº‘éŸ³ä¹æ’ä»¶åŠæœ¬åœ°å¤‡ç”¨æ–¹æ¡ˆ -->
<div style="position: fixed; right: 20px; bottom: 20px; z-index: 10000;">
  <!-- ç½‘æ˜“äº‘æ’­æ”¾å™¨ -->
  <div id="neteasePlayerContainer">
    <iframe 
      id="neteasePlayer"
      frameborder="no" 
      border="0" 
      marginwidth="0" 
      marginheight="0" 
      width="330" 
      height="86" 
      src="https://music.163.com/outchain/player?type=2&id=14177411150&auto=1&height=66">
    </iframe>
  </div>
  
  <!-- æœ¬åœ°MP3å¤‡ç”¨æ’­æ”¾å™¨ (é»˜è®¤éšè—) -->
  <div id="localPlayerContainer" style="display: none; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
    <p style="margin: 0 0 10px 0; font-size: 12px; color: #fff; text-align: center;">ç½‘æ˜“äº‘æ’­æ”¾å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ä»½</p>
    <audio 
      id="localPlayer" 
      controls 
      style="width: 300px; height: 40px;"
      src="{{ '/assets/audio/Summer (Nature''s Crescendo).mp3' | relative_url }}">
      ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
    </audio>
  </div>
</div>

<script>
// æ£€æµ‹ç½‘æ˜“äº‘æ’­æ”¾å™¨æ˜¯å¦åŠ è½½æˆåŠŸ
function checkNeteasePlayer() {
  // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥
  setTimeout(() => {
    const neteaseContainer = document.getElementById('neteasePlayerContainer');
    const localContainer = document.getElementById('localPlayerContainer');
    
    // æ£€æŸ¥iframeæ˜¯å¦æ­£å¸¸åŠ è½½
    const iframe = document.getElementById('neteasePlayer');
    if (iframe) {
      // å°è¯•æ£€æµ‹iframeå†…å®¹æ˜¯å¦åŠ è½½æˆåŠŸ
      try {
        // æ›´å‡†ç¡®çš„æ£€æµ‹æ–¹æ³•ï¼šæ£€æŸ¥iframeçš„srcæ˜¯å¦æ­£å¸¸åŠ è½½
        const iframeSrc = iframe.src;
        console.log('ç½‘æ˜“äº‘æ’­æ”¾å™¨åœ°å€:', iframeSrc);
        
        // æ£€æŸ¥iframeæ˜¯å¦å¯è§ä¸”æœ‰å†…å®¹
        const isVisible = iframe.offsetWidth > 0 && iframe.offsetHeight > 0;
        const hasContent = iframe.contentDocument || iframe.contentWindow;
        
        if (!isVisible || !hasContent) {
          console.log('ç½‘æ˜“äº‘æ’­æ”¾å™¨åŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°æ’­æ”¾å™¨');
          // ç½‘æ˜“äº‘æ’­æ”¾å™¨åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºæœ¬åœ°æ’­æ”¾å™¨
          neteaseContainer.style.display = 'none';
          localContainer.style.display = 'block';
          
          // è‡ªåŠ¨æ’­æ”¾æœ¬åœ°éŸ³é¢‘
          const localPlayer = document.getElementById('localPlayer');
          if (localPlayer) {
            console.log('å°è¯•æ’­æ”¾æœ¬åœ°éŸ³é¢‘æ–‡ä»¶');
            // å°è¯•è‡ªåŠ¨æ’­æ”¾ï¼ˆå—æµè§ˆå™¨æ”¿ç­–é™åˆ¶ï¼‰
            localPlayer.play().catch(err => {
              console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’:', err);
            });
          }
        } else {
          console.log('ç½‘æ˜“äº‘æ’­æ”¾å™¨åŠ è½½æˆåŠŸ');
          // å¦‚æœç½‘æ˜“äº‘æ’­æ”¾å™¨æ­£å¸¸ï¼Œéšè—æœ¬åœ°æ’­æ”¾å™¨
          localContainer.style.display = 'none';
        }
      } catch (error) {
        console.error('æ£€æµ‹æ’­æ”¾å™¨çŠ¶æ€æ—¶å‡ºé”™:', error);
        // å‡ºé”™æ—¶ä¹Ÿåˆ‡æ¢åˆ°æœ¬åœ°æ’­æ”¾å™¨
        neteaseContainer.style.display = 'none';
        localContainer.style.display = 'block';
      }
    }
  }, 5000); // 5ç§’åæ£€æŸ¥ï¼Œç»™è¶³åŠ è½½æ—¶é—´
}

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæ£€æµ‹
window.addEventListener('load', checkNeteasePlayer);

// å¦‚æœç½‘æ˜“äº‘æ’­æ”¾å™¨åŠ è½½å¤±è´¥ï¼Œæä¾›æ‰‹åŠ¨åˆ‡æ¢æŒ‰é’®
document.addEventListener('DOMContentLoaded', function() {
  // æ·»åŠ ä¸€ä¸ªå°çš„åˆ‡æ¢æŒ‰é’®
  const toggleButton = document.createElement('div');
  toggleButton.innerHTML = 'ğŸµ';
  toggleButton.style.cssText = `
    position: fixed;
    right: 20px;
    bottom: 120px;
    z-index: 10001;
    width: 30px;
    height: 30px;
    background: rgba(0,0,0,0.7);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
  `;
  
  toggleButton.addEventListener('click', function() {
    const neteaseContainer = document.getElementById('neteasePlayerContainer');
    const localContainer = document.getElementById('localPlayerContainer');
    
    if (neteaseContainer.style.display !== 'none') {
      neteaseContainer.style.display = 'none';
      localContainer.style.display = 'block';
      this.style.background = 'rgba(255,0,0,0.7)';
      this.innerHTML = 'ğŸ§';
      console.log('åˆ‡æ¢åˆ°æœ¬åœ°æ’­æ”¾å™¨');
      
      // å°è¯•æ’­æ”¾æœ¬åœ°éŸ³é¢‘
      const localPlayer = document.getElementById('localPlayer');
      if (localPlayer) {
        localPlayer.play().catch(err => {
          console.log('æœ¬åœ°æ’­æ”¾å™¨æ’­æ”¾å¤±è´¥:', err);
        });
      }
    } else {
      neteaseContainer.style.display = 'block';
      localContainer.style.display = 'none';
      this.style.background = 'rgba(0,0,0,0.7)';
      this.innerHTML = 'ğŸµ';
      console.log('åˆ‡æ¢åˆ°ç½‘æ˜“äº‘æ’­æ”¾å™¨');
    }
  });
  
  // æ·»åŠ æ‚¬åœæ•ˆæœ
  toggleButton.addEventListener('mouseenter', function() {
    this.style.transform = 'scale(1.1)';
    this.title = 'ç‚¹å‡»åˆ‡æ¢æ’­æ”¾å™¨';
  });
  
  toggleButton.addEventListener('mouseleave', function() {
    this.style.transform = 'scale(1)';
  });
  
  document.body.appendChild(toggleButton);
  
  // æ·»åŠ çŠ¶æ€æŒ‡ç¤ºå™¨
  const statusIndicator = document.createElement('div');
  statusIndicator.innerHTML = 'ğŸµ ç½‘æ˜“äº‘';
  statusIndicator.style.cssText = `
    position: fixed;
    right: 20px;
    bottom: 160px;
    z-index: 10001;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    opacity: 0.8;
    transition: opacity 0.3s ease;
  `;
  
  // æ‚¬åœæ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
  statusIndicator.addEventListener('mouseenter', function() {
    this.style.opacity = '1';
  });
  
  statusIndicator.addEventListener('mouseleave', function() {
    this.style.opacity = '0.8';
  });
  
  document.body.appendChild(statusIndicator);
  
  // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
  function updateStatusIndicator() {
    const neteaseContainer = document.getElementById('neteasePlayerContainer');
    const localContainer = document.getElementById('localPlayerContainer');
    
    if (neteaseContainer.style.display !== 'none') {
      statusIndicator.innerHTML = 'ğŸµ ç½‘æ˜“äº‘æ’­æ”¾å™¨';
      statusIndicator.style.background = 'rgba(0,150,255,0.8)';
    } else {
      statusIndicator.innerHTML = 'ğŸ§ æœ¬åœ°æ’­æ”¾å™¨';
      statusIndicator.style.background = 'rgba(255,100,100,0.8)';
    }
  }
  
  // ç›‘å¬æ’­æ”¾å™¨åˆ‡æ¢ï¼Œæ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
  const observer = new MutationObserver(updateStatusIndicator);
  const neteaseContainer = document.getElementById('neteasePlayerContainer');
  const localContainer = document.getElementById('localPlayerContainer');
  
  if (neteaseContainer) {
    observer.observe(neteaseContainer, { attributes: true, attributeFilter: ['style'] });
  }
  if (localContainer) {
    observer.observe(localContainer, { attributes: true, attributeFilter: ['style'] });
  }
});
</script>
