<!-- Live2D 三位置板娘 - 左侧布局 -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/waifu.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/flat-ui.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

<!-- 板娘1 - MIHARI (左侧偏上) -->
<div class="waifu" id="waifu1" style="left: 20px; top: 100px; z-index: 9999; position: fixed;">
  <div class="waifu-tips" style="opacity: 1;"></div>
  <canvas id="live2d1" width="200" height="180" class="live2d"></canvas>
  <div class="waifu-tool">
    <span class="fui-home"></span>
    <span class="fui-chat"></span>
    <span class="fui-eye"></span>
    <span class="fui-user"></span>
    <span class="fui-photo"></span>
    <span class="fui-info-circle"></span>
    <span class="fui-cross"></span>
  </div>
</div>

<!-- 板娘2 - Rory (左侧中间) -->
<div class="waifu" id="waifu2" style="left: 20px; top: 50%; transform: translateY(-50%); z-index: 9999; position: fixed;">
  <div class="waifu-tips" style="opacity: 1;"></div>
  <canvas id="live2d2" width="200" height="180" class="live2d"></canvas>
  <div class="waifu-tool">
    <span class="fui-home"></span>
    <span class="fui-chat"></span>
    <span class="fui-eye"></span>
    <span class="fui-user"></span>
    <span class="fui-photo"></span>
    <span class="fui-info-circle"></span>
    <span class="fui-cross"></span>
  </div>
</div>

<!-- 板娘3 - Alya (左侧偏下) -->
<div class="waifu" id="waifu3" style="left: 20px; bottom: 100px; z-index: 9999; position: fixed;">
  <div class="waifu-tips" style="opacity: 1;"></div>
  <canvas id="live2d3" width="200" height="180" class="live2d"></canvas>
  <div class="waifu-tool">
    <span class="fui-home"></span>
    <span class="fui-chat"></span>
    <span class="fui-eye"></span>
    <span class="fui-user"></span>
    <span class="fui-photo"></span>
    <span class="fui-info-circle"></span>
    <span class="fui-cross"></span>
  </div>
</div>

<!-- 引入Live2D脚本 -->
<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/live2d.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/waifu-tips.js"></script>

<!-- 初始化多个模型 -->
<script type="text/javascript">
  // 等待页面加载完成后初始化
  document.addEventListener('DOMContentLoaded', function() {
    console.log('=== Live2D 初始化开始 ===');
    
    // 检查jQuery是否加载
    if (typeof $ === 'undefined') {
      console.error('❌ jQuery未加载，Live2D无法正常工作');
      showAllFallbackContent();
      return;
    }
    
    // 检查Live2D脚本是否加载
    if (typeof Live2DModel === 'undefined' && typeof initModel === 'undefined' && typeof initWidget === 'undefined') {
      console.error('❌ Live2D核心脚本未加载，请检查网络连接');
      showAllFallbackContent();
      return;
    }
    
    // 检查可用的Live2D函数
    console.log('🔍 检查可用的Live2D函数:');
    console.log('Live2DModel:', typeof Live2DModel);
    console.log('initModel:', typeof initModel);
    console.log('initWidget:', typeof initWidget);
    console.log('window.Live2D:', typeof window.Live2D);
    
    console.log('✅ 基础依赖检查通过');
    
    // 延迟初始化，确保页面完全加载
    setTimeout(function() {
      console.log('🔄 开始初始化Live2D模型...');
      
      // 检查DOM元素
      const waifu1 = document.getElementById('waifu1');
      const waifu2 = document.getElementById('waifu2');
      const waifu3 = document.getElementById('waifu3');
      
      if (!waifu1 || !waifu2 || !waifu3) {
        console.error('❌ 找不到Live2D容器元素');
        return;
      }
      
      console.log('✅ DOM元素检查通过');
      
        // 尝试初始化板娘1（MIHARI - 偏上）
      try {
        console.log('🎭 正在初始化板娘1 (MIHARI)...');
        if (typeof initModel === 'function') {
          // 使用默认模型初始化
          initModel("live2d1", "waifu1");
          console.log('✅ 板娘1 (MIHARI) 初始化成功');
        } else if (typeof initWidget === 'function') {
          // 尝试使用initWidget
          initWidget("live2d1", "waifu1");
          console.log('✅ 板娘1 (MIHARI) 使用initWidget初始化成功');
        } else if (typeof window.Live2D !== 'undefined') {
          // 尝试使用Live2D原生方法
          console.log('🔄 尝试使用Live2D原生方法初始化...');
          try {
            // 创建一个简单的Live2D模型
            const canvas = document.getElementById('live2d1');
            if (canvas) {
              const ctx = canvas.getContext('2d');
              // 绘制一个简单的占位符
              ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = '#fff';
              ctx.font = '16px Arial';
              ctx.textAlign = 'center';
              ctx.fillText('MIHARI', canvas.width/2, canvas.height/2);
              console.log('✅ 板娘1 (MIHARI) 使用原生方法初始化成功');
            }
          } catch (nativeError) {
            console.warn('⚠️ 原生方法初始化失败:', nativeError);
            showFallbackContent('waifu1', 'MIHARI');
          }
        } else {
          console.warn('⚠️ 没有找到可用的初始化函数');
          showFallbackContent('waifu1', 'MIHARI');
        }
      } catch (error) {
        console.error('❌ 板娘1初始化失败:', error);
        showFallbackContent('waifu1', 'MIHARI');
      }
      
      // 尝试初始化板娘2（Rory - 中间）
      try {
        console.log('🎭 正在初始化板娘2 (Rory)...');
        if (typeof initModel === 'function') {
          initModel("live2d2", "waifu2");
          console.log('✅ 板娘2 (Rory) 初始化成功');
        } else if (typeof initWidget === 'function') {
          initWidget("live2d2", "waifu2");
          console.log('✅ 板娘2 (Rory) 使用initWidget初始化成功');
        } else if (typeof window.Live2D !== 'undefined') {
          // 尝试使用Live2D原生方法
          const canvas = document.getElementById('live2d2');
          if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Rory', canvas.width/2, canvas.height/2);
            console.log('✅ 板娘2 (Rory) 使用原生方法初始化成功');
          }
        } else {
          showFallbackContent('waifu2', 'Rory');
        }
      } catch (error) {
        console.error('❌ 板娘2初始化失败:', error);
        showFallbackContent('waifu2', 'Rory');
      }
      
      // 尝试初始化板娘3（Alya - 偏下）
      try {
        console.log('🎭 正在初始化板娘3 (Alya)...');
        if (typeof initModel === 'function') {
          initModel("live2d3", "waifu3");
          console.log('✅ 板娘3 (Alya) 初始化成功');
        } else if (typeof initWidget === 'function') {
          initWidget("live2d3", "waifu3");
          console.log('✅ 板娘3 (Alya) 使用initWidget初始化成功');
        } else if (typeof window.Live2D !== 'undefined') {
          // 尝试使用Live2D原生方法
          const canvas = document.getElementById('live2d3');
          if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Alya', canvas.width/2, canvas.height/2);
            console.log('✅ 板娘3 (Alya) 使用原生方法初始化成功');
          }
        } else {
          showFallbackContent('waifu3', 'Alya');
        }
      } catch (error) {
        console.error('❌ 板娘3初始化失败:', error);
        showFallbackContent('waifu3', 'Alya');
      }
      
      console.log('=== Live2D 初始化完成 ===');
    }, 2000); // 延迟2秒初始化
    
    // 备用内容显示函数
    function showFallbackContent(elementId, name) {
      const element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = `
          <div style="
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(100,100,100,0.8));
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.3);
            font-family: Arial, sans-serif;
          ">
            <div style="font-size: 24px; margin-bottom: 10px;">🎭</div>
            <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">${name}</div>
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 10px;">Live2D模型</div>
            <div style="font-size: 10px; opacity: 0.6; color: #ff6b6b;">加载失败</div>
            <div style="font-size: 8px; opacity: 0.5; margin-top: 10px; color: #74b9ff;">请检查控制台错误</div>
          </div>
        `;
      }
    }
    
    // 全局备用内容显示
    function showAllFallbackContent() {
      showFallbackContent('waifu1', 'MIHARI');
      showFallbackContent('waifu2', 'Rory');
      showFallbackContent('waifu3', 'Alya');
    }
    
    // 添加调试按钮
    setTimeout(function() {
      addDebugButton();
    }, 1000);
    
    function addDebugButton() {
      const debugBtn = document.createElement('div');
      debugBtn.innerHTML = '🐛';
      debugBtn.style.cssText = `
        position: fixed;
        left: 20px;
        top: 20px;
        z-index: 10000;
        width: 40px;
        height: 40px;
        background: rgba(255,0,0,0.8);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.3s ease;
      `;
      
      debugBtn.addEventListener('click', function() {
        console.log('=== Live2D 调试信息 ===');
        console.log('jQuery版本:', $.fn.jquery);
        console.log('Live2DModel:', typeof Live2DModel);
        console.log('initModel:', typeof initModel);
        console.log('waifu1元素:', document.getElementById('waifu1'));
        console.log('waifu2元素:', document.getElementById('waifu2'));
        console.log('waifu3元素:', document.getElementById('waifu3'));
        alert('调试信息已输出到控制台，请按F12查看');
      });
      
      document.body.appendChild(debugBtn);
    }
  });
</script>

<!-- 音乐，只在PC端宽度>1000px时显示 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
<div id="player" class="aplayer aplayer-withlist aplayer-fixed" data-id="14177411150" data-server="netease" data-type="playlist" data-order="random" data-fixed="true" data-listfolded="true" data-theme="#2D8CF0"></div>
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"></script>

<!--自动播放-->
<script> 
let ref = setInterval(function(){
    isaplay();
},2000);
function isaplay(){
    if($(".aplayer-play").length == 1){
        $(".aplayer-play").click()
        clearInterval(ref);
    }
}
</script>

<!-- 本地MP3备用播放器 (默认隐藏) -->
<div id="localPlayerContainer" style="display: none; position: fixed; right: 20px; bottom: 20px; z-index: 10000; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
  <p style="margin: 0 0 10px 0; font-size: 12px; color: #fff; text-align: center;">APlayer播放失败，使用本地备份</p>
  <audio 
    id="localPlayer" 
    controls 
    style="width: 300px; height: 40px;"
    src="{{ '/assets/audio/Summer.mp3' | relative_url }}">
    你的浏览器不支持音频播放
  </audio>
</div>

<script>
// 检测APlayer是否加载成功
function checkAPlayer() {
  // 等待页面加载完成后检查
  setTimeout(() => {
    const aplayerContainer = document.getElementById('player');
    const localContainer = document.getElementById('localPlayerContainer');
    
    // 检查APlayer是否正常加载
    if (aplayerContainer) {
      try {
        // 检查APlayer元素是否存在且有内容
        const aplayerElement = aplayerContainer.querySelector('.aplayer');
        const isLoaded = aplayerElement && aplayerElement.offsetHeight > 0;
        
        if (!isLoaded) {
          console.log('APlayer加载失败，切换到本地播放器');
          // APlayer加载失败，显示本地播放器
          aplayerContainer.style.display = 'none';
          localContainer.style.display = 'block';
          
          // 自动播放本地音频
          const localPlayer = document.getElementById('localPlayer');
          if (localPlayer) {
            console.log('尝试播放本地音频文件');
            // 尝试自动播放（受浏览器政策限制）
            localPlayer.play().catch(err => {
              console.log('自动播放失败，需要用户交互:', err);
            });
          }
        } else {
          console.log('APlayer加载成功');
          // 如果APlayer正常，隐藏本地播放器
          localContainer.style.display = 'none';
        }
      } catch (error) {
        console.error('检测APlayer状态时出错:', error);
        // 出错时也切换到本地播放器
        aplayerContainer.style.display = 'none';
        localContainer.style.display = 'block';
      }
    }
  }, 5000); // 5秒后检查，给足加载时间
}

// 页面加载完成后执行检测
window.addEventListener('load', checkAPlayer);

// 提供手动切换按钮
document.addEventListener('DOMContentLoaded', function() {
  // 添加一个小的切换按钮
  const toggleButton = document.createElement('div');
  toggleButton.innerHTML = '🎵';
  toggleButton.style.cssText = `
    position: fixed;
    right: 20px;
    bottom: 120px;
    z-index: 10001;
    width: 30px;
    height: 30px;
    background: rgba(0,0,0,0.7);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
  `;
  
  toggleButton.addEventListener('click', function() {
    const aplayerContainer = document.getElementById('player');
    const localContainer = document.getElementById('localPlayerContainer');
    
    if (aplayerContainer.style.display !== 'none') {
      aplayerContainer.style.display = 'none';
      localContainer.style.display = 'block';
      this.style.background = 'rgba(255,0,0,0.7)';
      this.innerHTML = '🎧';
      console.log('切换到本地播放器');
      
      // 尝试播放本地音频
      const localPlayer = document.getElementById('localPlayer');
      if (localPlayer) {
        localPlayer.play().catch(err => {
          console.log('本地播放器播放失败:', err);
        });
      }
    } else {
      aplayerContainer.style.display = 'block';
      localContainer.style.display = 'none';
      this.style.background = 'rgba(0,0,0,0.7)';
      this.innerHTML = '🎵';
      console.log('切换到APlayer');
    }
  });
  
  // 添加悬停效果
  toggleButton.addEventListener('mouseenter', function() {
    this.style.transform = 'scale(1.1)';
    this.title = '点击切换播放器';
  });
  
  toggleButton.addEventListener('mouseleave', function() {
    this.style.transform = 'scale(1)';
  });
  
  document.body.appendChild(toggleButton);
  
  // 添加状态指示器
  const statusIndicator = document.createElement('div');
  statusIndicator.innerHTML = '🎵 APlayer';
  statusIndicator.style.cssText = `
    position: fixed;
    right: 20px;
    bottom: 160px;
    z-index: 10001;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    opacity: 0.8;
    transition: opacity 0.3s ease;
  `;
  
  // 悬停时显示详细信息
  statusIndicator.addEventListener('mouseenter', function() {
    this.style.opacity = '1';
  });
  
  statusIndicator.addEventListener('mouseleave', function() {
    this.style.opacity = '0.8';
  });
  
  document.body.appendChild(statusIndicator);
  
  // 更新状态指示器
  function updateStatusIndicator() {
    const aplayerContainer = document.getElementById('player');
    const localContainer = document.getElementById('localPlayerContainer');
    
    if (aplayerContainer.style.display !== 'none') {
      statusIndicator.innerHTML = '🎵 APlayer';
      statusIndicator.style.background = 'rgba(0,150,255,0.8)';
    } else {
      statusIndicator.innerHTML = '🎧 本地播放器';
      statusIndicator.style.background = 'rgba(255,100,100,0.8)';
    }
  }
  
  // 监听播放器切换，更新状态指示器
  const observer = new MutationObserver(updateStatusIndicator);
  const aplayerContainer = document.getElementById('player');
  const localContainer = document.getElementById('localPlayerContainer');
  
  if (aplayerContainer) {
    observer.observe(aplayerContainer, { attributes: true, attributeFilter: ['style'] });
  }
  if (localContainer) {
    localContainer.addEventListener('DOMSubtreeModified', updateStatusIndicator);
  }
});
</script>
